<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DesimodX | INFINITE QUANTUM FORGE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Michroma&display=swap');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Michroma', sans-serif; cursor: crosshair; }
        
        /* DESIMODX OPERATING SYSTEM HUD */
        #os-interface { position: fixed; inset: 0; pointer-events: none; z-index: 100; border: 20px solid rgba(0, 255, 255, 0.05); }
        .stark-hud { 
            position: absolute; background: rgba(0, 15, 25, 0.7); 
            border: 1px solid #00f2ff; backdrop-filter: blur(15px); 
            padding: 20px; box-shadow: 0 0 50px rgba(0, 242, 255, 0.2); 
            clip-path: polygon(10% 0, 100% 0, 100% 90%, 90% 100%, 0 100%, 0 10%);
        }
        #top-system { top: 0; left: 0; right: 0; height: 80px; display: flex; align-items: center; justify-content: center; background: none; border-bottom: 1px solid rgba(0, 242, 255, 0.3); }
        #tools-matrix { top: 120px; left: 40px; width: 220px; height: auto; }
        #blueprint-data { top: 120px; right: 40px; width: 320px; text-align: right; }
        #bottom-jarvis { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); font-family: 'Syncopate'; font-weight: 700; letter-spacing: 10px; font-size: 20px; color: #fff; text-shadow: 0 0 10px #00f2ff; }
        
        video { position: fixed; bottom: 30px; left: 30px; width: 180px; border: 2px solid #00f2ff; filter: hue-rotate(180deg) brightness(1.1); transform: scaleX(-1); border-radius: 5px; opacity: 0.6; }
        .data-stream { color: #00f2ff; font-size: 9px; line-height: 2; border-bottom: 1px solid rgba(0, 242, 255, 0.1); }
        .btn-core { pointer-events: auto; background: rgba(0, 255, 255, 0.1); border: 1px solid #00f2ff; color: #00f2ff; width: 100%; padding: 10px; margin: 10px 0; font-family: inherit; font-size: 10px; cursor: pointer; transition: 0.2s; }
        .btn-core:hover { background: #00f2ff; color: #000; transform: skewX(-5deg); }
        #visual-alert { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; transition: 0.2s; }
    </style>
</head>
<body>

<div id="visual-alert" style="box-shadow: inset 0 0 200px #ff0055;"></div>

<div id="os-interface">
    <div id="top-system">
        <div style="font-size: 30px; font-weight: 700; letter-spacing: 10px;">Desimod<span style="color:#00f2ff">X</span></div>
    </div>

    <div id="tools-matrix" class="stark-hud">
        <div style="font-size:10px; margin-bottom: 15px; color:#ffcc00">SYSTEM MODE: FORGING</div>
        <button class="btn-core" onclick="changeMat(0xff0044, 'S-TITANIUM')">SUIT METAL [RED]</button>
        <button class="btn-core" onclick="changeMat(0x00f2ff, 'PLASMA')">ARC_PLASMA [BLUE]</button>
        <button class="btn-core" onclick="changeMat(0xbb00ff, 'DARK-MATTER')">VIBRANIUM [PURPLE]</button>
        <button class="btn-core" onclick="toggleSym()" id="symBtn">SYMMETRY: ACTIVE</button>
        <button class="btn-core" style="color:red; border-color:red" onclick="purge()">PURGE CORE</button>
    </div>

    <div id="blueprint-data" class="stark-hud">
        <div class="data-stream">> DESIMODX ARCHIVE v4.2</div>
        <div class="data-stream">> NEURAL LINK: SYNCHRONIZED</div>
        <div class="data-stream" id="poly">MOLECULES: 0 / 2M</div>
        <div class="data-stream" id="load-info">CORE_LOAD: 0%</div>
        <div id="load-ring" style="width: 60px; height: 60px; border: 2px solid #00f2ff; border-radius: 50%; margin-top: 20px; border-top-color: transparent; animation: spin 2s linear infinite;"></div>
    </div>

    <div id="bottom-jarvis">DESIMODX // FORGE ACTIVE</div>
</div>

<video id="input_video"></video>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { Hands } from "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js";
import { Camera } from "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";

// --- STARTUP PARAMS ---
const MAX_MATTER = 1800000;
let scene, camera, renderer, composer, particles;
let positions, colors, pIdx = 0;
let symX = true, currentColor = new THREE.Color(0x00f2ff);

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 15;

    renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: 'high-performance' });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 2.2, 0.4, 0.8));

    const geo = new THREE.BufferGeometry();
    positions = new Float32Array(MAX_MATTER * 3);
    colors = new Float32Array(MAX_MATTER * 3);
    geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const mat = new THREE.PointsMaterial({ size: 0.04, vertexColors: true, transparent: true, blending: THREE.AdditiveBlending });
    particles = new THREE.Points(geo, mat);
    scene.add(particles);

    window.addEventListener('resize', onWindowResize);
}

// --- DESIMODX OS COMMANDS ---
window.changeMat = (hex, label) => { currentColor.set(hex); document.getElementById('bottom-jarvis').innerText = label + "_ENGAGED"; };
window.toggleSym = () => { symX = !symX; document.getElementById('symBtn').innerText = "SYMMETRY: " + (symX ? "ACTIVE" : "DISABLED"); };
window.purge = () => { pIdx = 0; positions.fill(0); particles.geometry.attributes.position.needsUpdate = true; document.getElementById('visual-alert').style.opacity = '0.4'; setTimeout(()=>document.getElementById('visual-alert').style.opacity='0', 500); };

// --- GESTURE PROCESSING ---
const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.9 });

hands.onResults((res) => {
    if(res.multiHandLandmarks) {
        res.multiHandLandmarks.forEach((lm, i) => {
            const side = res.multiHandedness[i].label;
            const x = (0.5 - lm[9].x) * 22;
            const y = (0.5 - lm[9].y) * 16;
            const z = -lm[9].z * 15;

            if(side === 'Right') {
                const pinching = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.04;
                if(pinching) {
                    draw(x, y, z);
                    if(symX) draw(-x, y, z); // Mirrored Suit Logic
                }
            } else {
                particles.rotation.y = THREE.MathUtils.lerp(particles.rotation.y, (lm[9].x - 0.5) * 4, 0.1);
                particles.rotation.x = THREE.MathUtils.lerp(particles.rotation.x, (lm[9].y - 0.5) * 4, 0.1);
            }
        });
    }
});

function draw(x, y, z) {
    if(pIdx >= MAX_MATTER) return;
    const v = new THREE.Vector3(x, y, z).applyQuaternion(particles.quaternion.clone().invert());
    const idx3 = pIdx * 3;
    positions[idx3] = v.x; positions[idx3+1] = v.y; positions[idx3+2] = v.z;
    colors[idx3] = currentColor.r; colors[idx3+1] = currentColor.g; colors[idx3+2] = currentColor.b;
    pIdx++;
    particles.geometry.attributes.position.needsUpdate = true;
    particles.geometry.attributes.color.needsUpdate = true;
    document.getElementById('poly').innerText = `MOLECULES: ${pIdx.toLocaleString()} / 1.8M`;
    document.getElementById('load-info').innerText = `CORE_LOAD: ${(pIdx/MAX_MATTER*100).toFixed(0)}%`;
}

// --- WORLD UPDATES ---
const cam = new Camera(document.getElementById('input_video'), {
    onFrame: async () => { await hands.send({ image: document.getElementById('input_video') }); }
});
cam.start();

function animate() {
    requestAnimationFrame(animate);
    composer.render();
}

function onWindowResize() { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

init();
animate();
</script>

<style> @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} } </style>
</body>
</html>
